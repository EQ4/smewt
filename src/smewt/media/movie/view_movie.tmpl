#set movieData = $movie

<%
from collections import defaultdict
from smewt import SmewtUrl, Media
from smewt.media import Movie
from smewt.base.utils import smewtDirectory, guessCountryCode

flags_dir = smewtDirectory('smewt', 'media', 'common', 'images', 'flags')

movie = movieData.findAll(Movie)[0]
movieName = movie['title']
poster = movie['loresImage']

def getAll(prop):
    return ', '.join(movie[prop] or [])

director = getAll('director')
writer = getAll('writer')
genres = getAll('genres')
englishSubsLink = SmewtUrl('action', 'getsubtitles', { 'title': movieName, 'language': 'en' })
frenchSubsLink = SmewtUrl('action', 'getsubtitles', { 'title': movieName, 'language': 'fr' })

playLink = None
files = []
subtitles = []

languageFiles = defaultdict(lambda: [])

for media in movieData.findAll(Media):
    if media.type() == 'video':
        files.append(media.filename)

    elif media.type() == 'subtitle':
        langs = guessCountryCode(media.filename)

        mediaFilename = movieData.findOne(Media, method = lambda x: x.type()=='video' and media.filename.startswith(os.path.splitext(x.filename)[0])).filename
        subtitleFilename = media.filename

        for lang in langs:
            languageFiles[lang] += [ (mediaFilename, subtitleFilename) ]

for lang, files in languageFiles.items():
    nfile = 1
    args = {}

    for (mediaFilename, subtitleFilename) in sorted(files):
        args['filename%d' % nfile] = mediaFilename
        args['subtitle%d' % nfile] = subtitleFilename
        nfile += 1

    subtitles.append( {'languageImage': flags_dir + '/%s.png' % (lang,),
                        'url': SmewtUrl('action', 'play', args)} )


nfile = 1
args = {}
for f in sorted(files):
    args['filename%d' % nfile] = f
    nfile += 1

if args:
    playLink = SmewtUrl('action', 'play', args)

subtitles.sort(key = lambda x: x['languageImage'])

from smewt.base.utils import smewtDirectory
import_dir = smewtDirectory('smewt', 'media')

%>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>single movie display</title>
<script type="text/javascript" src="file://$(import_dir)/3rdparty/tabber.js"></script>
<link rel="stylesheet" href="file://$(import_dir)/movie/movies.css" type="text/css">
</head>

<body>

<img src="file://$poster" />

<div class="rightshifted">
  <h1>$movieName</h1>

  <a href="$englishSubsLink">Get missing English subtitles</a>
  <a href="$frenchSubsLink">Get missing French subtitles</a>
#if playLink:
  <a href="$playLink">Play Movie</a>
  #for s in subtitles
     <a href="$s.url"><img src="file://$s.languageImage" /></a>
  #end for
#end if
</div>

<div class="tabber">
  <div class="tabbertab">
    <h2>Overview</h2>
    <p><b>year:</b> $movie.year</p>
    <p><b>rating:</b> $movie.rating</p>
    <p><b>director:</b> $director</p>
    <p><b>writer:</b> $writer</p>
    <p><b>genres:</b> $genres</p>
    <p><b>plot outline:</b> $movie.plotOutline</p>
    #if $movie.plot:
      <p><b>plot:</b> $movie.plot[0]</p>
      #if len($movie.plot) > 1:
        <p><b>detailed plot:</b> $movie.plot[1]</p>
      #end if
    #end if
  </div>

  <div class="tabbertab">
    <h2>Cast</h2>
    #for person, role in $movie.cast
      <p>$person  ---  $role</p>
    #end for
    <p></p>
  </div>

</div>


</body>
</html>
